name: Fetch GangNamMatJip Campaigns

on:
  workflow_dispatch:

jobs:
  fetch-html:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup folders
        run: |
          mkdir -p html_cache/visit
          mkdir -p html_cache/shipping

      - name: Fetch Visit Pages
        run: |
          for ca in 2005 2010 2015 2020 2025 2030 2035; do
            for page in {0..5}; do
              url="https://xn--939au0g4vj8sq.net/theme/go/_list_cmp_tpl.php?ca=$ca&rpage=$page&row_num=28"
              echo "Fetching Visit CA=$ca Page=$page"
              attempt=0
              success=0
              while [ $attempt -lt 3 ]; do
                if curl -s --max-time 60 "$url" -o "html_cache/visit/${ca}_page_${page}.html"; then
                  success=1
                  break
                else
                  attempt=$((attempt + 1))
                  echo "Retry $attempt..."
                  sleep 5
                fi
              done
              if [ $success -eq 0 ]; then
                echo "Failed to fetch $url after 3 attempts"
              fi
              sleep 2
            done
          done

      - name: Fetch Shipping Pages
        run: |
          for ca in 3005 3010 3015 3020 3030; do
            for page in {0..5}; do
              url="https://xn--939au0g4vj8sq.net/theme/go/_list_cmp_tpl.php?ca=$ca&rpage=$page&row_num=28"
              echo "Fetching Shipping CA=$ca Page=$page"
              attempt=0
              success=0
              while [ $attempt -lt 3 ]; do
                if curl -s --max-time 60 "$url" -o "html_cache/shipping/${ca}_page_${page}.html"; then
                  success=1
                  break
                else
                  attempt=$((attempt + 1))
                  echo "Retry $attempt..."
                  sleep 5
                fi
              done
              if [ $success -eq 0 ]; then
                echo "Failed to fetch $url after 3 attempts"
              fi
              sleep 2
            done
          done

      - name: Commit HTML Cache
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add html_cache/
          git commit -m "Update GangNamMatJip HTML cache" || echo "No changes to commit"
          git push
