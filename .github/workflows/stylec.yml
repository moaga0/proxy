name: stylec-crawler 

on:
  workflow_dispatch:
    inputs:
      visitMaxPage:
        required: true
        default: "5"
      shippingMaxPage:
        required: true
        default: "20"

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Init result
        run: |
          echo '{
            "visit": { "pages": [] },
            "shipping": { "pages": [] }
          }' > result.json

      - name: Crawl Visit Trials
        run: |
          for ((p=1; p<=${{ inputs.visitMaxPage }}; p++))
          do
            RES=$(curl -s \
              -H "User-Agent: Mozilla/5.0" \
              -H "Referer: https://www.stylec.co.kr/" \
              "https://api2.stylec.co.kr:6439/v1/trial?order=wr_last&page=$p&count=50&campaignType[]=배달형&campaignType[]=방문형&include_finish=false")

            COUNT=$(echo "$RES" | jq '.data.data | length')
            if [ "$COUNT" -eq 0 ]; then break; fi

            # 상세 정보도 추가
            DETAILED=$(echo "$RES" | jq '.data.data | map(. + {detail: ( .wrId as $id | (curl -s -H "User-Agent: Mozilla/5.0" -H "Referer: https://www.stylec.co.kr/" "https://api2.stylec.co.kr:6439/v1/trial/detail?wr_id=\($id)" | fromjson))})')

            jq --argjson page "$p" --argjson data "$DETAILED" \
              '.visit.pages += [{"page": $page, "data": $data}]' \
              result.json > tmp.json && mv tmp.json result.json
          done

      - name: Crawl Shipping Trials
        run: |
          for ((p=1; p<=${{ inputs.shippingMaxPage }}; p++))
          do
            RES=$(curl -s \
              -H "User-Agent: Mozilla/5.0" \
              -H "Referer: https://www.stylec.co.kr/" \
              "https://api2.stylec.co.kr:6439/v1/trial?order=wr_last&page=$p&count=50&campaignType[]=미션/인증&campaignType[]=배달형&campaignType[]=구매평&campaignType[]=페이백＋구매평&campaignType[]=페이백형&include_finish=false")

            COUNT=$(echo "$RES" | jq '.data.data | length')
            if [ "$COUNT" -eq 0 ]; then break; fi

            # 상세 정보 포함
            DETAILED=$(echo "$RES" | jq '.data.data | map(. + {detail: ( .wrId as $id | (curl -s -H "User-Agent: Mozilla/5.0" -H "Referer: https://www.stylec.co.kr/" "https://api2.stylec.co.kr:6439/v1/trial/detail?wr_id=\($id)" | fromjson))})')

            jq --argjson page "$p" --argjson data "$DETAILED" \
              '.shipping.pages += [{"page": $page, "data": $data}]' \
              result.json > tmp.json && mv tmp.json result.json
          done

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: stylec-result
          path: result.json
