name: stylec-crawler

on:
  workflow_dispatch:
    inputs:
      visitMaxPage:
        required: true
        default: "5"
      shippingMaxPage:
        required: true
        default: "20"

jobs:
  crawl:
    runs-on: ubuntu-latest

    env:
      PROXY_LIST: |
        socks5h://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@${{ secrets.PROXY_HOST }}:${{ secrets.PROXY_PORT }}
        socks5h://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@${{ secrets.PROXY_HOST_2 }}:${{ secrets.PROXY_PORT_2 }}
        socks5h://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@${{ secrets.PROXY_HOST_3 }}:${{ secrets.PROXY_PORT_3 }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Initialize result.json
        run: |
          echo '{
            "visit": { "pages": [] },
            "shipping": { "pages": [] }
          }' > result.json

      - name: Prepare temp folders
        run: |
          mkdir -p tmp/visit tmp/shipping

      # ==============================
      # ÏÑ∏ÏÖò Îã®ÏúÑ UA + ÌîÑÎ°ùÏãú ÏÑ†ÌÉù
      # ==============================
      - name: Select Session UA & Proxy
        id: session
        run: |
          UA_LIST='
          Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (Chrome/120.0.0.0 Safari/537.36)
          Mozilla/5.0 (Macintosh; Intel Mac OS X 13_5) AppleWebKit/605.1.15 (Version/16.6 Safari/605.1.15)
          Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0
          Mozilla/5.0 (Macintosh; Intel Mac OS X 14_2) AppleWebKit/537.36 (Chrome/121.0.0.0 Safari/537.36)
          '

          SELECTED_UA=$(echo "$UA_LIST" | sed '/^$/d' | shuf -n 1 | sed 's/^ *//;s/ *$//')
          SELECTED_PROXY=$(echo "$PROXY_LIST" | sed '/^$/d' | shuf -n 1 | sed 's/^ *//;s/ *$//')

          echo "SELECTED_UA=$SELECTED_UA" >> $GITHUB_OUTPUT
          echo "SELECTED_PROXY=$SELECTED_PROXY" >> $GITHUB_OUTPUT

          echo "üßë‚Äçüíª Session UA: $SELECTED_UA"
          echo "üåê Session Proxy: $SELECTED_PROXY"

      - name: Debug Proxy
        run: |
          echo "Testing proxy: ${{ steps.session.outputs.SELECTED_PROXY }}"
          curl -x "${{ steps.session.outputs.SELECTED_PROXY }}" https://ipinfo.io || echo "‚ö†Ô∏è PROXY TEST FAILED"

      # ==============================
      # VISIT ÌÅ¨Î°§ÎßÅ
      # ==============================
      - name: Crawl Visit Trials with Details (Parallel)
        run: |
          for ((p=1; p<=${{ inputs.visitMaxPage }}; p++)); do
            echo "Fetching Visit Trials Page $p"

            RES=$(curl -s \
              -x "${{ steps.session.outputs.SELECTED_PROXY }}" \
              -A "${{ steps.session.outputs.SELECTED_UA }}" \
              -H "Referer: https://www.stylec.co.kr/" \
              "https://api2.stylec.co.kr:6439/v1/trial?order=wr_last&page=$p&count=50&campaignType[]=%EB%B0%A9%EB%AC%B8%ED%98%95&include_finish=false")

            COUNT=$(echo "$RES" | jq '.data.data | length')
            if [ "$COUNT" -eq 0 ]; then
              echo "No more Visit Trials, stopping."
              break
            fi

            # Î≥ëÎ†¨ ÏÉÅÏÑ∏ Îã§Ïö¥Î°úÎìú (20Í∞ú)
            echo "$RES" | jq -r '.data.data[].wr_id' | xargs -n1 -P20 -I{} sh -c \
              "curl -s \
                -x '${{ steps.session.outputs.SELECTED_PROXY }}' \
                -A '${{ steps.session.outputs.SELECTED_UA }}' \
                -H 'Referer: https://www.stylec.co.kr/' \
                'https://api2.stylec.co.kr:6439/v1/trial/detail?wr_id={}' > tmp/visit/{}.json"

            jq -s '.' tmp/visit/*.json > tmp/visit_page_${p}.json
            jq --arg p "$p" --slurpfile pageData tmp/visit_page_${p}.json \
               '.visit.pages += [{"page": ($p|tonumber), "data": $pageData[0]}]' result.json > tmp.json
            mv tmp.json result.json
            rm tmp/visit/*.json
          done

      # ==============================
      # SHIPPING ÌÅ¨Î°§ÎßÅ
      # ==============================
      - name: Crawl Shipping Trials with Details (Parallel)
        run: |
          for ((p=1; p<=${{ inputs.shippingMaxPage }}; p++)); do
            echo "Fetching Shipping Trials Page $p"

            RES=$(curl -s \
              -x "${{ steps.session.outputs.SELECTED_PROXY }}" \
              -A "${{ steps.session.outputs.SELECTED_UA }}" \
              -H "Referer: https://www.stylec.co.kr/" \
              "https://api2.stylec.co.kr:6439/v1/trial?order=wr_last&page=$p&count=50&campaignType[]=%EB%AF%B8%EC%85%98%2F%EC%9D%B8%EC%A6%9D&campaignType[]=%EB%B0%B0%EB%8B%AC%ED%98%95&campaignType[]=%EA%B5%AC%EB%A7%A4%ED%8F%89&campaignType[]=%ED%8E%98%EC%9D%B4%EB%B0%B1%EF%BC%8B%EA%B5%AC%EB%A7%A4%ED%8F%89&campaignType[]=%ED%8E%98%EC%9D%B4%EB%B0%B1%ED%98%95&include_finish=false")

            COUNT=$(echo "$RES" | jq '.data.data | length')
            if [ "$COUNT" -eq 0 ]; then
              echo "No more Shipping Trials, stopping."
              break
            fi

            echo "$RES" | jq -r '.data.data[].wr_id' | xargs -n1 -P20 -I{} sh -c \
              "curl -s \
                -x '${{ steps.session.outputs.SELECTED_PROXY }}' \
                -A '${{ steps.session.outputs.SELECTED_UA }}' \
                -H 'Referer: https://www.stylec.co.kr/' \
                'https://api2.stylec.co.kr:6439/v1/trial/detail?wr_id={}' > tmp/shipping/{}.json"

            jq -s '.' tmp/shipping/*.json > tmp/shipping_page_${p}.json
            jq --arg p "$p" --slurpfile pageData tmp/shipping_page_${p}.json \
               '.shipping.pages += [{"page": ($p|tonumber), "data": $pageData[0]}]' result.json > tmp.json
            mv tmp.json result.json
            rm tmp/shipping/*.json
          done

      - name: Upload result.json
        uses: actions/upload-artifact@v4
        with:
          name: stylec-result
          path: result.json
