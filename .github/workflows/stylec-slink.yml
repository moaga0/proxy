name: stylec-slink

on:
  workflow_dispatch:
    inputs:
      wrIds:
        description: "Comma separated wr_id list (e.g. 123,456,789)"
        required: true

jobs:
  slink:
    runs-on: ubuntu-latest

    env:
      PROXY_URL: "socks5h://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@${{ secrets.PROXY_HOST }}:${{ secrets.PROXY_PORT }}"
      STYLEC_COOKIE: "${{ secrets.STYLEC_COOKIE }}"
      UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36"

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch slinks (Parallel=5) and build slink.json
        run: |
          set -euo pipefail

          # 입력 wrIds -> 줄 단위로 정리
          echo "${{ inputs.wrIds }}" | tr ',' '\n' | sed '/^\s*$/d' > wrids.txt
          mkdir -p tmp/slink

          # wr_id 별로 요청 (병렬 5)
          cat wrids.txt | xargs -P5 -I{} bash -c '
            set -euo pipefail
            WRID="$1"

            RES="$(curl -sS -x "$PROXY_URL" \
              -H "User-Agent: $UA" \
              -H "Cookie: $STYLEC_COOKIE" \
              -H "Origin: https://www.stylec.co.kr" \
              -H "Referer: https://www.stylec.co.kr/trials/${WRID}" \
              --data-urlencode "pagePath=/trials/${WRID}" \
              "https://www.stylec.co.kr/api/util/modal.share.php" || true)"

            SLINK="$(echo "$RES" | jq -r ".slink // empty" 2>/dev/null || true)"

            # { "wrId": "slink" } 단일 객체로 저장
            jq -n --arg k "$WRID" --arg v "$SLINK" "{(\$k): \$v}" > "tmp/slink/${WRID}.json"
          ' _ {}

          # ✅ tmp/slink/*.json이 하나도 없을 때도 안전하게 {} 생성
          if ls tmp/slink/*.json >/dev/null 2>&1; then
            jq -s 'add' tmp/slink/*.json > slink.json
          else
            echo '{}' > slink.json
          fi

      - name: Upload slink.json
        uses: actions/upload-artifact@v4
        with:
          name: stylec-slink
          path: slink.json
